var request,timer,sendCancel,isChecked,timer_off=!1,initialized=!1,events=acom_analytics.e,MENU_TIME=1500,PDF_MENU_TIME=3e3,FADE_TIME=1500;function sendMessage(e,t){"use strict";delete e.trefoilClick,delete e.trefoilUI,util.messageToMain(e),delete e.newUI,delete e.analytics,timer&&(clearTimeout(timer),timer=null),t||"dismiss"===e.content_op||sendCancel()}function analytics(e){"use strict";request.analytics||(request.analytics=[]),request.analytics.push(e)}function clearTimer(){"use strict";util.consoleLog("Clear timer: "+timer),timer&&(clearTimeout(timer),timer=null),SETTINGS.IS_ERP_READER?$(".acrobatMainDiv").stop().css("display","none"):($(".acrobatMainDiv").stop().css("opacity",1),$(".convert-status").stop().css("opacity",1))}function sendCancel(){"use strict";request.content_op="dismiss",request.main_op="relay_to_content",request.newUI=!0,sendMessage(request)}function hideAway(){$(".convert-status").addClass("hidden"),$(".progress-area").addClass("hidden")}function fadeAway(){"use strict";timer=null,$(".convert-status").animate({opacity:0},FADE_TIME,"linear",hideAway)}function setTimer(){"use strict";(SETTINGS.TEST_MODE||SETTINGS.DEBUG_MODE)&&(timer=1),timer||timer_off||(timer=setTimeout(function(){setTimeout(fadeAway)},request.is_pdf?PDF_MENU_TIME:MENU_TIME))}function doAcrobat(){"use strict";request.main_op="open_in_acrobat",request.newUI=!0,request.trefoilUI=!1,delete request.content_op,request.version===SETTINGS.READER_VER?analytics(events.TREFOIL_PDF_READER):analytics(events.PERSIST_PDF_ACROBAT),sendMessage(request,!0)}function to_toggle(e){"use strict";isChecked=e,util.setCookie("ViewResultsPref",isChecked?"true":"false",3650),$(".do_set_open_pref").toggleClass("open-pdf-in-acrobat")}function initialize(){"use strict";initialized||(initialized=!0,$(".do_acrobat").click(function(e){var t=$(e.currentTarget);clearTimer(),t.hasClass("do_acrobat")&&doAcrobat()}),$(".close-dialog").click(function(){analytics(events.PERSIST_PDF_MENU_CLOSED),sendCancel()}),$(".always-show").prop("checked","false"!==util.getCookie("always-show-pdf-menu")),$(".always-show").click(function(){var e=$(".always-show").prop("checked")?"true":"false";util.setCookie("always-show-pdf-menu",e,3650)}))}function dump(e,t){"use strict";if(SETTINGS.DEBUG_MODE){var s,a=[t];for(s in e)e.hasOwnProperty(s)&&a.push("  "+s+": "+e[s]);console.log(a.join("\n"))}}function tester(e){"use strict";switch(util.consoleLog("TESTING"),util.consoleLogDir(JSON.stringify(e)),e.test_extension){case"doAcrobat":doAcrobat()}}function setStatus(e){"use strict";var t,s,a,n=!0,i=!0,r=!1,o="web2pdfStatusFailure",l="web2pdfStatusComplete";if(e.test_extension)return tester(e);if(e.version===SETTINGS.ERP_READER_VER&&(SETTINGS.IS_ERP_READER=!0),e.persist)switch(initialize(),delete(request=e).analytics,timer_off=!1,$(".acrobatMainDiv").stop().css("opacity",1),util.translateElements(".translate"),1===request.version&&$("#web2pdfOpenButtonText").val(util.getTranslation("web2pdfOpenButtonTextOlder")),request.version===SETTINGS.READER_VER&&$("#web2pdfOpenButtonText").val(util.getTranslation("web2pdfOpenButtonTextReader")),$(".ui-element").addClass("hidden"),$("#action_message").text(""),request.displayName&&!SETTINGS.USE_ACROBAT&&($(".displayName").text(request.displayName),$(".sign-out").removeClass("hidden"),$(".action-signout").removeClass("hidden")),dump(request,"Receive frame message:"),s=request.panel_op,delete request.panel_op,s){case"pdf_menu":SETTINGS.USE_ACROBAT?$(".acro-option.pdf").removeClass("hidden"):$(".api-option.pdf").removeClass("hidden"),$(".acro-option.horizontal-rule").removeClass("hidden"),$(".acrobatMainDiv").off("hover");break;case"error":$(".error").removeClass("hidden").text("Unexpected Error:"+request.error.name+"\nReference: "+request.error.errnum+"\n"+request.error.details);break;case"flickr":$(".action-available").removeClass("hidden"),$("#action_message").text("Create slide shows and contact sheets."),$(".special_question").removeClass("hidden"),$("#special").removeClass("hidden");break;case"status":$(".progress-area").removeClass("hidden"),$(".convert").text(request.domtitle),$(".convert-status, .convert-title").addClass("hidden"),$(".convert").removeClass("convert-button hidden"),$(".acrobatMainDiv").off("hover"),"waiting"===request.current_status?(analytics(events.TREFOIL_HTML_CONVERT_WAITING),t=util.getTranslation("web2pdfStatusWaiting"),n=!1):"downloading"===request.current_status?(analytics(events.TREFOIL_HTML_CONVERT_DOWNLOADING),t=util.getTranslation("web2pdfStatusDownloading"),n=!1):"in_progress"===request.current_status?(analytics(events.TREFOIL_HTML_CONVERT_IN_PROGRESS),t=util.getTranslation("web2pdfStatusInProgress"),n=!1):"filelocked"===request.current_status?t=util.getTranslation("web2pdfFileLockedError"):"cancelled"===request.current_status?(analytics(events.TREFOIL_HTML_CONVERT_CANCELLED),t=util.getTranslation("web2pdfStatusCancelled"),r=!0):"complete"===request.current_status?(analytics(events.TREFOIL_HTML_CONVERT_COMPLETE),request.file_path?($(".convert").text(util.getTranslation("web2pdfOpenInDCButtonText")),$(".convert").addClass("convert-button")):($(".convert").empty(),$(".convert").addClass("hidden"))):"failure"===request.current_status?(analytics(events.TREFOIL_HTML_CONVERT_FAILED),request.message&&(t=request.message,t=$("<div/>").text(t).html()),i=!1):"noacrobat"===request.current_status?(analytics(events.TREFOIL_HTML_CONVERT_NO_ACROBAT),t=util.getTranslation("web2pdfUnsupportedAcrobatVersion"),i=!1):"unknown"===request.current_status?(t=util.getTranslation("web2pdfStatusUnknownFailure"),i=!1):"pdf_downloading"===request.current_status?(t=util.getTranslation("web2pdfStatusDownloadingPDF"),n=!1):"pdf_failure"===request.current_status?(analytics(events.PERSIST_PDF_DOWNLOAD_FAILED),i=!(o="web2pdfStatusUnknownFailure")):"pdf_downloaded"===request.current_status?(t=util.getTranslation("web2pdfPDFOpening"),n=!1):"pdf_opened"===request.current_status?(i=!0,l="web2pdfPDFOpened"):"pdf_open_failed"===request.current_status&&(n=!(i=!1),o="web2pdfPDFOpenFailedv2"),t&&($(".in-process").removeClass("hidden"),$(".convert-title").removeClass("hidden"),$(".convert-title").html(t)),n?(delete request.panel_op,$(".acrobatMainDiv").hover(clearTimer,setTimer),$(".actions").removeClass("hidden"),$(".in-process").addClass("hidden"),a=SETTINGS.USE_ACROBAT?request.is_pdf?".acro-option.pdf":".acro-option.html":request.is_pdf?".api-option.pdf":".api-option.html",$(a).removeClass("hidden"),$(".convert").removeClass("convert-busy"),$(".convert-status").removeClass("hidden"),$(".convert-status").stop().css("opacity",1),i?($(".convert-status-icon").addClass("icon-success"),$(".convert-status-title").text(util.getTranslation(l))):($(".convert-status-icon").removeClass("icon-success"),$(".convert-status-icon").addClass("icon-error"),$(".convert-status-title").text(util.getTranslation(o)),$(".convert").addClass("hidden")),r&&($(".convert-status").addClass("hidden"),$(".convert").addClass("hidden")),setTimer()):(timer_off=!0,$(".actions").addClass("hidden"),$(".convert").addClass("convert-busy"))}}util.isChrome()&&$(function(){"use strict";initialize()}),util.addMainListener(setStatus),$(function(){"use strict";window.location.search&&(request=JSON.parse(decodeURIComponent(window.location.search.split("=")[1])),SETTINGS.TEST_MODE&&window.addEventListener("message",function(e){setStatus(e.data)},!1),setStatus(request),isChecked="false"!==util.getCookie("ViewResultsPref")&&($(".do_set_open_pref").addClass("open-pdf-in-acrobat"),!0))});