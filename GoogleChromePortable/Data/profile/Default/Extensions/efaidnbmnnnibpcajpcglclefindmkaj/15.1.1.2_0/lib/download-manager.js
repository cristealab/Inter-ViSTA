function dependOn(){"use strict";return[require("communicate"),require("common"),require("util"),require("proxy"),require("analytics"),require("feat")]}var def;require=function(e){"use strict";return e},def=window.define?window.define:function(e,t){"use strict";return t.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};def(dependOn(),function(r,a,p,i,s,e){"use strict";var t,n,o,l,d=null;for(n in o=function(){return r.getModule("upload")},l=function(){return r.getModule("session")},t=function(){this.proxy=i.proxy.bind(this),this.LOG=a.LOG,this.uploadHandler=function(i){var n=["application/illustrator","image/bmp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.adobe.form.fillsign","image/gif","application/x-indesign","image/jpeg","image/jpeg","application/vnd.oasis.opendocument.formula","application/vnd.oasis.opendocument.graphics","application/vnd.oasis.opendocument.presentation","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.text","image/png","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/mspowerpoint","application/postscript","image/vnd.adobe.photoshop","application/vnd.ms-publisher","application/x-tika-msoffice","text/rtf","application/vnd.sun.xml.writer.template","application/vnd.sun.xml.draw","application/vnd.sun.xml.calc","application/vnd.sun.xml.impress","application/vnd.sun.xml.writer","text/plain","image/tiff","image/tiff","text/plain","application/vnd.ms-excel","application/msexcel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/zip"],o=i.request;i.id&&(o.assetId=i.id,p.ajax({url:a.settings.files_api+"assets/"+i.id+"/metadata",type:"GET",headers:a.GET_headers()}).done(this.proxy(function(e){if(delete o.create_path,delete o.export_path,delete o.form_path,delete o.preview_path,o.preview_path="file/"+i.id,o.send_path="send/file/"+i.id,o.fillsign=!1,s.event(s.e.UPLOAD_COMPLETE),"application/pdf"===e.content_type&&(o.export_path="exportpdf/"+i.id,o.fillsign=!0),-1!==n.indexOf(e.content_type)&&(o.create_path="convertpdf/"+i.id,o.fillsign=!1),"fillsign"===o.handleResult)delete o.handleResult,this.fill_sign(o);else if(o.handleResult){p.consoleLog("handleResult: "+o.handleResult);var t={preview:o.preview_path,image_preview:o.preview_path,export:o.export_path,send:o.send_path,to_pdf:o.create_path}[o.handleResult];s.event(s.e.REDIRECT),delete o.handleResult,l().gotoPath(t)}})))},this.do_upload=function(e,t){var i={"upload-image":s.e.CONTEXT_UPLOAD_IMAGE,upload_link:s.e.CONTEXT_UPLOAD_LINK,upload:s.e.CONTEXT_UPLOAD_PDF_PAGE}[e.menuItem];i&&(s.event(i),delete e.menuItem),o().upload(e).done(this.proxy(this.uploadHandler))},this.sign_out=function(e,t){l().signOut()},this.dismiss=function(e,t){p.consoleLog("dismiss/ok")},this.specialCases=SETTINGS.USE_FLICKR?[{regex:/http[s]:\/\/www\.flickr\.com/,action:"flickr",lastPromptTime:null}]:[],this.handleSpecialUrl=function(o,a){var s=!1;return p.each(this.specialCases,function(e,t){if(t.regex.test(o)){var i=!0,n=(new Date).getTime();t.lastPromptTime&&n-t.lastPromptTime<1e4&&(i=!1),i&&(t.lastPromptTime=n,p.consoleLog("INVITE: "+n),r.deferMessage({panel_op:t.action,tabId:a})),s=!0}}),s},this.fill_sign=function(t,e){(t.userSelectPromise||p.Deferred().resolve().promise()).then(this.proxy(function(){p.consoleLog("fill and sign");var e={url:a.settings.fillsign_api+"createform",contentType:"application/json",accept:a.GET_headers().Accept,type:"POST",dataType:"json",xhrFields:{withCredentials:!0},headers:a.POST_headers()};e.data=JSON.stringify({asset_id:t.assetId}),l().message("Preparing for Fill and Sign",!0),s.event(s.e.CREATE_FORM_PROGRESS_SHOWN),p.ajax(e).then(this.proxy(function(e){p.consoleLog("form created"),p.consoleLogDir(e),t.form_path="fillsign/"+e.form_id,s.event(s.e.CREATE_FORM_COMPLETE),s.event(s.e.REDIRECT),l().gotoPath(t.form_path)}),this.proxy(function(e){return p.consoleLog("form create failed"),i.REST_error(e,this),e}))}))},this.newTab=function(e,t,i){var n,o=chrome.runtime.getURL("data/js/options.html");if(SETTINGS.CHROME_VERSION<SETTINGS.SUPPORTED_VERSION)return chrome.browserAction.setIcon({path:"data/images/acrobat_dc_appicon_24.png",tabId:t}),void chrome.browserAction.enable(t);if(0!==e.indexOf(a.settings.redirect_uri+"?code=")){if(e.includes(o))return n=s.getAnalyticsUsage(),e.includes("?os=mac")?o+="?os=mac":o+="?anl="+n,SETTINGS.USE_ACROBAT||(o+="&env="+a.settings.env),e!==o?void chrome.tabs.update(t,{url:o,active:!0}):void s.event(s.e.OPTIONS_PAGE);l().checkSessionTab(t,e),r.avoidUrl(e)?r.disable(t):d.handleSpecialUrl(e,t)||r.loaded(t)}else l().foundCode(e)},this.startup=function(e,t){this.started||(this.newTab(e.url,t.tab.id,e.is_pdf?"application/pdf":"text/html"),this.started=!0),e.is_pdf&&r.pdf_menu(e,t)}},d||(d=new t,r.registerModule("download-manager",d)),d)d.hasOwnProperty(n)&&("function"==typeof d[n]?exports[n]=d[n].bind(d):exports[n]=d[n]);return r.registerHandlers({do_upload:d.proxy(d.do_upload),dismiss:d.proxy(d.dismiss),ok:d.proxy(d.dismiss),fillsign:d.proxy(d.fill_sign),"sign-out":d.proxy(d.sign_out),"html-startup":d.proxy(d.startup),"pdf-menu":d.proxy(d.startup)}),p.isChrome()&&chrome.tabs.onUpdated.addListener(d.proxy(function(e,t,i){"complete"===t.status?d.newTab(i.url,e):"loading"===t.status&&r.loading({id:e})})),p.isFF()&&(d.proxy(function(){var e=require("chrome").Cu,t=e.import("resource://gre/modules/Downloads.jsm").Downloads,i=e.import("resource://gre/modules/Task.jsm").Task,n={onDownloadAdded:function(e){if(p.consoleLog("Added",e),p.consoleLog("Added Content type: "+e.contentType),!r.avoidUrl(e.source.url)){var t={filename:e.target.path.replace(/\S*(\\|\/)/,""),url:e.source.url,panel_op:"pdf_menu"};r.deferMessage(t)}}};i.spawn(function(){try{t.getList(t.ALL).then(function(e){p.consoleLogDir(e),e.addView(n)})}catch(e){p.consoleError(e)}})})(),require("sdk/tabs").on("ready",function(e){e.url;d.newTab(e.url,e.id,e.contentType)}),require("chrome").Cu.import("resource://gre/modules/Services.jsm")),d});