function dependOn(){"use strict";return[require("util"),require("common"),require("proxy"),require("communicate"),require("analytics")]}var def;require=function(e){"use strict";return e},def=window.define?window.define:function(e,t){"use strict";return t.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};def(dependOn(),function(n,o,a,e,c){"use strict";var t,l,r=null;for(t in function(){return e.getModule("upload")},l=function(){return e.getModule("convert-to-zip")},r||(r=new function(){var r,s,i;this.proxy=a.proxy.bind(this),this.LOG=o.LOG,this.updateName=function(e,t){if(!e||!t)return n.Deferred().resolve().promise();var r=o.settings.files_api+"assets/"+e+"/metadata/name",s=JSON.stringify({value:t,on_dup_name:"auto_rename"});return n.ajax({type:"PUT",url:r,data:s,headers:o.POST_headers()}).then(function(){},this.proxy(function(e){a.REST_error(e,this,{url:r,data:s})}))},this.updateParent=function(e,t){if(!e||!t)return n.Deferred().resolve().promise();var r=o.settings.files_api+"assets/"+i.assetId+"/metadata/parent_id",s=JSON.stringify({value:t,on_dup_name:"auto_rename"});return n.ajax({type:"PUT",url:r,data:s,headers:o.POST_headers()}).then(function(){},this.proxy(function(e){a.REST_error(e,this,{url:r,data:s})}))},this.rename=function(e){var t=n.Deferred();return this.updateName(e.assetId,e.filename).then(this.proxy(function(){this.updateParent(e.assetId,e.dest_folder).then(function(){t.resolve()},function(){t.reject()})}),function(){t.reject()}),t.promise()},this.gotoPath=function(t){var e=n.Deferred();i.userSelectPromise?i.userSelectPromise.then(function(){e.resolve()},function(){e.reject()}):e.resolve(),e.then(this.proxy(function(){o.sso_url(t).then(this.proxy(function(e){s?(n.isChrome()&&chrome.tabs.update(s,{url:e.uri,active:!0}),s=null):n.createTab(e.uri)}),this.proxy(function(e){t=o.settings.cloud_host+t,s?(n.isChrome()&&chrome.tabs.update(s,{url:t,active:!0}),s=null):n.createTab(t)}))}))},this.file_spec_done=function(e){i.dest_folder=e.dest_folder;var t=i.filename;"zip"!==t.substring(t.length-3,t.length)&&(i.filename=e.filename),i.upload_promise.then(this.proxy(function(){this.rename(i).then(function(){i.userSelectPromise.resolve()},function(){i.userSelectPromise.reject()})}))},this.message=function(e,t,r){s&&n.sendMessage({tabId:s,progress_op:r?"set-error":"set-text",text:e,busy:t})},this.foundCode=function(e){var t=e.split("?")[1].split("=")[1].split("&")[0];this.newSession(null,!0),c.event(c.e.SIGN_IN_COMPLETE),o.authorize(t).then(function(){r&&r.resolve(),r=null},function(){r&&r.reject(),r=null})},this.sessionRequest=function(e,t){(i=e).params=t||{filename:i.filename}},this.send_folders=function(){this.signed_in().then(this.proxy(function(){c.event(c.e.UPLOAD_RENAME_CLICKED),n.ajax({type:"POST",headers:o.POST_headers(),url:o.settings.files_api+"search",data:JSON.stringify({q:{object_type:"folder"},metadata:["id","name","created","parent_id"]})}).then(this.proxy(function(e){s&&(e.results.push({parent_id:null,object_type:"root",created:"2015-03-31T11:37:40",id:o.settings.files_root,name:"/"}),n.sendMessage({tabId:s,progress_op:"folders",folders:e.results}))}),this.proxy(function(e,t,r){a.REST_error(e,this)}))}))},this.newSession=function(e,t,r){(r=r||i.params).filename&&(i.userSelectPromise=n.Deferred()),e||(n.isChrome()&&(e=chrome.runtime.getURL("data/js/progress.html")+"#"+n.param(r)),r.filename&&this.send_folders()),s?n.isChrome()&&chrome.tabs.update(s,{url:e,active:!0}):(n.isChrome()&&chrome.tabs.create({url:e},this.proxy(function(e){t&&(s=e.id)})),n.isFF()&&require("sdk/windows").browserWindows.open({url:e}))},this.sign_in=function(e,t){return r&&(r.reject(),r=null,c.event(c.e.SIGN_IN_ABANDONED)),r=n.Deferred(),o.baseUris().then(this.proxy(function(){var e={client_id:o.settings.ims_client_id,redirect_uri:o.settings.redirect_uri,scope:"AdobeID, skybox, openid",dc:!1},t=o.settings.ims_host+"ims/authorize/v1?"+n.param(e);c.event(c.e.SIGN_IN_SHOWN),this.newSession(t,!0)})),r.promise()},this.signed_in=function(){return r||n.Deferred().resolve().promise()},this.signOut=function(){n.isChrome()&&chrome.tabs.create({url:o.settings.ims_host+"ims/logout/v1?"+n.param({access_token:o.settings.auth_token.replace(/Bearer /,""),client_id:o.settings.ims_client_id,client_secret:o.settings.ims_client_secret,redirect_uri:"https://adobe.com"})}),o.clearAuth()},this.checkSessionTab=function(e,t){e===s&&-1===t.indexOf("chrome-extension:")&&-1===t.indexOf(".adobe.com/")&&(s=null,r&&(r.reject(),r=null,c.event(c.e.SIGN_IN_ABANDONED)))},this.goto_acom=function(e){SETTINGS.USE_ACROBAT?n.createTab(o.settings.cloud_host):(this.sessionRequest(e,{}),this.gotoPath("files"))},this.html_to_pdf=function(e,t){e.filename=t.tab.title.replace(/[\*"\/\\'&\.]/g,"")+".pdf",this.sessionRequest(e,{filename:e.filename,message:"Gathering HTML Content",busy:"true",progress_op:"htmlToPdf"}),this.sign_in(e,t).then(this.proxy(function(){n.isChrome()&&chrome.tabs.executeScript(e.tabId,{code:"var maxSize= "+SETTINGS.MAX_HTML_SIZE+", DEBUG = "+SETTINGS.DEBUG_MODE+", TABID = "+e.tabId+", OP = 'html-blob', EXCLUDE = [];",allFrames:!0},function(){chrome.tabs.executeScript(e.tabId,{file:"data/js/get-html.js",allFrames:!0})})}))},this.relay_message=function(e){e.complete?e.error?(n.consoleLog(e.error),c.event(c.e.HTML_SOURCE_SIZE_TOO_LARGE_ERROR)):(e.html_op="serialize_iframe",n.isChrome()&&chrome.tabs.executeScript(e.tabId,{code:"if (window.dc && window.OP) { receiveIframe("+JSON.stringify(e)+"); }",allFrames:!0})):n.isChrome()&&chrome.tabs.executeScript(e.tabId,{code:"if (window.dc && window.OP) {serialize("+JSON.stringify(e)+"); }",allFrames:!0})},this.flickr=function(e){this.sessionRequest(e,{}),this.newSession(null,!1,{unavailable:"flickr"})},this.error=function(e){if(s){i&&i.userSelectPromise&&i.userSelectPromise.reject();var r=["Please Report this Error:"];n.each(e,function(e,t){r.push(e+": "+t)}),this.message(r.join("\n"),!1,!0),s=null}},a.handlers(this.error.bind(this)),n.isChrome()&&chrome.tabs.onRemoved.addListener(function(e){e===s&&(s=null,r&&(c.event(c.e.SIGN_IN_ABANDONED),r.reject(),r=null))}),this.html_blob=function(e){if(e.error)n.consoleError(e.error),c.logError(e.error,e.analytics[0]);else{c.logContents(e),c.checkAndLogHTMLBlobSize(e.blob.currentSize/1048576),e.analytics&&c.setParamsAndLogAnalytics(e.analytics,c.e.HTML_SOURCE_CONTENT,"content"),c.setArg("stage","CLONE"),c.checkAndLogTimingRange(e.cloneTiming),n.consoleLog("html blob send to:"+s);var t=JSON.stringify(e.blob);l().compress(t,i)}}},e.registerHandlers({goto_acom:r.proxy(r.goto_acom),html_to_pdf:r.proxy(r.html_to_pdf),flickr:r.proxy(r.flickr),file_spec_done:r.proxy(r.file_spec_done),"html-blob":r.proxy(r.html_blob),"relay-msg":r.proxy(r.relay_message)}),e.registerModule("session",r)),r)r.hasOwnProperty(t)&&("function"==typeof r[t]?exports[t]=r[t].bind(r):exports[t]=r[t]);return r});